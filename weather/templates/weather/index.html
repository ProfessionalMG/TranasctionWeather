{% load static %}
{% include 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}

    <div class="col-8 mt-5">
        <div id="alert-box"></div>
        <form id="a-form" class="form-group mt-5 text-center" method="post" action="{% url 'store' %}">
            {% csrf_token %}
            {{ form|crispy }}
            <button class="btn btn-lg btn-outline-secondary" type="submit">Submit</button>
        </form>
    </div>

    <div class="container mt-5">
        {% if forecasts %}
            <table class="table table-dark">
                <thead>
                <tr>
                    <th scope="col">Address</th>
                    <th scope="col">Date</th>
                    <th scope="col">Temp</th>
                </tr>
                </thead>
                <tbody>
                {% for cast in forecasts %}
                    <tr>
                        <td>{{ cast.address }}</td>
                        <td>{{ cast.date }}</td>
                        <td>{{ cast.feels_like }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>

{% endblock content %}

{% block javascript %}

    <script>
        const alertBox = document.getElementById('alert-box')
        const form = document.getElementById('a-form')
        const address = document.getElementById('id_address')
        const csrf = document.getElementsByName('csrfmiddlewaretoken')
        const url = '/home'

        const handleAlerts = (type, text) => {
            alertBox.innerHTML = '<div class="alert alert-${type}" role="alert">${text}</div>'
        }

        form.addEventListener('submit', ev => {
            e.preventDefault()
            const fd = new FormData()
            fd.append('csrfmiddlewaretoken', csrf[0].value)
            fd.append('address', address.value)

            $.ajax({
                type: 'POST',
                url: url,
                data: fd,
                success: function (response) {
                    console.log(response)
                    const sText = '${response.address}'
                    handleAlerts('success', sText)
                },
                error: function (error) {
                    console.log(error)
                    handleAlerts('danger', 'something went wrong')
                },
                cache: false,
                contentType: false,
                processData: false,
            })
        })
    </script>
{% endblock javascript %}